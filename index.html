<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FLL Missions & Team Progress — Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .card { background: rgba(17,24,39,0.65); border: 1px solid rgba(250,204,21,0.07); }
    /* SVG viewer styles */
    #svgViewport { width:100%; height:420px; border-radius: 0.5rem; background: #071018; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    #svgInner { transition: transform 260ms cubic-bezier(.2,.9,.2,1); transform-origin: 0 0; will-change: transform; cursor: grab; }
    #svgInner.dragging { cursor: grabbing; }
    /* small helpers */
    .btn { @apply px-3 py-1 rounded font-semibold; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen font-sans leading-relaxed">
  <div class="max-w-6xl mx-auto p-6">

    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="text-4xl font-extrabold mb-2 text-amber-400">FLL Missions & Team Progress 2025–26</h1>
      <a href="https://firstinspires.blob.core.windows.net/fll/challenge/2025-26/fll-challenge-unearthed-rgr.pdf"
         target="_blank" rel="noopener"
         class="text-blue-400 hover:text-blue-300 underline font-semibold">
        Official RGR PDF
      </a>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- Left: Missions & Rules -->
      <div class="space-y-6 card p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-semibold text-amber-300 mb-2">Missions</h2>

        <section class="space-y-4 text-gray-200 text-sm">
          <!-- Full missions content -->
          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 01 – Surface Brushing</h3>
            <p class="italic text-gray-400">Difficulty: 2/10</p>
            <ul class="list-disc pl-6 mt-2 space-y-1">
              <li>Soil deposits completely cleared, touching the mat. 10 pts each</li>
              <li>Archaeologist’s brush not touching the dig site. 10 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 02 – Map Reveal</h3>
            <p class="italic text-gray-400">Difficulty: 4/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Topsoil sections completely cleared. 10 pts each</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 03 – Mineshaft Explorer</h3>
            <p class="italic text-gray-400">Difficulty: 5/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Your minecart on opposing team's field: 30 pts</li>
              <li>Bonus: Opposing team’s minecart on your field: 10 pts</li>
            </ul>
            <p class="text-gray-400 text-xs mt-1">Note: Must pass completely through mineshaft entry. Bonus not possible if no opposing team.</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 04 – Careful Recovery</h3>
            <p class="italic text-gray-400">Difficulty: 10/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Precious artifact not touching mine: 30 pts</li>
              <li>Both support structures standing: 10 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 05 – Who Lived Here?</h3>
            <p class="italic text-gray-400">Difficulty: 4/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Structure floor upright: 30 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 06 – Forge</h3>
            <p class="italic text-gray-400">Difficulty: 5/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Ore blocks not touching forge: 10 pts</li>
            </ul>
            <p class="text-gray-400 text-xs mt-1">Note: Technicians may open ore blocks by hand in home to reveal fossil (Mission 14)</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 07 – Heavy Lifting</h3>
            <p class="italic text-gray-400">Difficulty: 7/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Millstone no longer touching base: 30 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 08 – Silo</h3>
            <p class="italic text-gray-400">Difficulty: 6/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Preserved pieces outside silo: 10 pts each</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 09 – What’s on Sale?</h3>
            <p class="italic text-gray-400">Difficulty: 8/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Roof completely raised: 20 pts</li>
              <li>Market wares raised: 10 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 10 – Tip the Scales</h3>
            <p class="italic text-gray-400">Difficulty: 10/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Scale tipped & touching mat: 20 pts</li>
              <li>Scale pan completely removed: 10 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 11 – Angler Artifacts</h3>
            <p class="italic text-gray-400">Difficulty: 4/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Artifacts raised above ground: 20 pts</li>
              <li>Bonus: Crane flag partly lowered: 10 pts</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 12 – Salvage Operation</h3>
            <p class="italic text-gray-400">Difficulty: 10/10</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Sand completely cleared: 20 pts</li>
              <li>Ship completely raised: 10 pts</li>
            </ul>
            <p class="text-gray-400 text-xs mt-1">Note: Sand cleared when pull activator past line on mat</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 13 – Forum</h3>
            <p class="italic text-gray-400">Difficulty: 10/10</p>
            <p class="mt-2">Artifacts touching mat & partly in forum (5 pts each):</p>
            <ul class="list-disc pl-6 mt-2">
              <li>Brush</li>
              <li>Topsoil</li>
              <li>Precious Artifact</li>
              <li>Opposing team’s minecart</li>
              <li>Ore with fossil</li>
              <li>Millstone</li>
              <li>Scale pan</li>
            </ul>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300">Mission 15 – Site Marking</h3>
            <ul class="list-disc pl-6 mt-2">
              <li>Sites with flag partly inside & touching mat: 10 pts each</li>
            </ul>
            <p class="text-gray-400 text-xs mt-1">Note: Sites outlined on mat wireframe</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold text-amber-300 mt-4">Precision Tokens</h3>
            <p class="text-gray-300 mt-1">Start with 6 tokens worth 50 pts. Lose one if robot interrupted outside home.</p>
            <ul class="list-disc pl-6 mt-2">
              <li>6: 50 pts</li>
              <li>5: 50 pts</li>
              <li>4: 35 pts</li>
              <li>3: 25 pts</li>
              <li>2: 15 pts</li>
              <li>1: 10 pts</li>
            </ul>
          </div>

          <div class="mt-4">
            <h3 class="text-xl font-bold text-amber-300">Rules (Important)</h3>
            <h4 class="mt-2 text-amber-200">Before Match</h4>
            <ol class="list-decimal pl-6 mt-2 space-y-2 text-gray-200">
              <li>Equipment must fit in 2 launch areas &amp; height ≤ 12 in (305 mm). Single launch area under limit: 20 pts</li>
              <li>No extra storage. Left/right of mat ~6.75 in x 45 in. Equipment may extend past walls.</li>
              <li>After inspection, distribute equipment &amp; mission models, place robot in launch area. Use time to adjust &amp; calibrate.</li>
              <li>Team splits left/right. Cannot switch sides.</li>
            </ol>
            <ul class="pl-8 mt-2 space-y-1 text-gray-300">
              <li>4+ members: 2 techs per home, others stand back</li>
              <li>3 members: 2 techs one side, 1 other</li>
              <li>2 members: 1 tech per side</li>
            </ul>
          </div>
        </section>
      </div>

      <!-- Right: Gallery + SVG viewer -->
      <div class="space-y-6">

        <!-- Gallery -->
        <div class="card p-6 rounded-2xl shadow-lg">
          <h2 class="text-2xl font-semibold text-amber-300 mb-3">Team Progress Gallery</h2>
          <p class="text-gray-300 text-sm mb-3">Google Drive folder (public view). Pre-filled with your folder ID — change if needed.</p>

          <div class="flex gap-2 mb-4">
            <input id="driveIdInput" type="text" value="19721zCMLXrOMm4rJ9bE5JQ-VZTuQwU5G"
                   placeholder="Folder ID or full Drive folder URL"
                   class="flex-1 p-2 rounded bg-gray-800 placeholder-gray-400 text-gray-100">
            <button id="setDriveBtn" class="px-4 py-2 bg-amber-400 text-gray-900 rounded font-semibold hover:bg-amber-500">Load</button>
          </div>

          <div id="galleryWrap" class="rounded-xl overflow-hidden border border-amber-400">
            <iframe src="https://drive.google.com/embeddedfolderview?id=19721zCMLXrOMm4rJ9bE5JQ-VZTuQwU5G#grid"
                    class="w-full h-[420px]" frameborder="0" allow="autoplay"></iframe>
          </div>

          <p class="text-gray-400 text-xs mt-3">Tip: Use 'Anyone with the link → Viewer' on the Drive folder.</p>
        </div>

        <!-- SVG viewer -->
        <div class="card p-6 rounded-2xl shadow-lg">
          <h2 class="text-2xl font-semibold text-amber-300 mb-3">SVG Viewer (live from GitHub)</h2>
          <p class="text-gray-300 text-sm mb-3">Raw GitHub SVG URL (pre-filled). Updating the file in GitHub updates this view. Use the refresh button if cached.</p>

          <div class="flex gap-2 mb-3">
            <input id="svgUrl" type="text"
                   value="https://raw.githubusercontent.com/jahaziel127g/fll-unearthed/main/icon.svg"
                   class="flex-1 p-2 rounded bg-gray-800 placeholder-gray-400 text-gray-100" />
            <button id="loadSvg" class="px-4 py-2 bg-amber-400 text-gray-900 rounded font-semibold hover:bg-amber-500">Load</button>
          </div>

          <div class="flex items-center gap-2 mb-3">
            <button id="zoomOut" class="btn bg-gray-700 hover:bg-gray-600 text-gray-100">-</button>
            <input id="zoomRange" type="range" min="0.2" max="3" step="0.05" value="1" class="w-full"/>
            <button id="zoomIn" class="btn bg-gray-700 hover:bg-gray-600 text-gray-100">+</button>

            <button id="fitBtn" class="ml-2 px-3 py-1 bg-gray-700 rounded hover:bg-gray-600">Fit</button>
            <button id="resetBtn" class="px-3 py-1 bg-gray-700 rounded hover:bg-gray-600">Reset</button>
            <button id="refreshBtn" class="ml-2 px-3 py-1 bg-amber-400 text-gray-900 rounded hover:bg-amber-500">Refresh</button>
          </div>

          <div class="flex items-center gap-3 text-xs text-gray-400 mb-3">
            <label class="flex items-center gap-2">
              <input id="autoRefresh" type="checkbox" /> Auto-refresh (30s)
            </label>
            <span id="svgStatus" class="ml-2">Idle</span>
            <a id="downloadSvg" class="ml-auto text-amber-300 underline cursor-pointer">Download SVG</a>
          </div>

          <div id="svgViewport" class="rounded-xl">
            <div id="svgInner" role="img" aria-label="SVG preview">
              <div class="text-gray-500">SVG not loaded yet.</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <footer class="mt-10 text-center text-gray-400 text-xs">
      Built for your FLL team — everything runs client-side in your browser.
    </footer>
  </div>

  <!-- Behavior script -->
  <script>
    // Utils: sanitize simple SVG text (remove script tags and on* attributes)
    function sanitizeSvgText(svgText) {
      // remove <script>...</script>
      svgText = svgText.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      // remove on... attributes (inline event handlers)
      svgText = svgText.replace(/\son[a-zA-Z]+\s*=\s*"[^"]*"/gi, '');
      svgText = svgText.replace(/\son[a-zA-Z]+\s*=\s*'[^']*'/gi, '');
      // remove javascript: URIs
      svgText = svgText.replace(/javascript:/gi, '');
      return svgText;
    }

    // --- SVG loader & viewer with pan & zoom ---
    const svgUrlInput = document.getElementById('svgUrl');
    const loadSvgBtn = document.getElementById('loadSvg');
    const svgInner = document.getElementById('svgInner');
    const svgViewport = document.getElementById('svgViewport');
    const statusEl = document.getElementById('svgStatus');
    const downloadLink = document.getElementById('downloadSvg');

    let scale = 1;
    let tx = 0, ty = 0;
    let isDragging = false;
    let dragStart = null;
    let svgOriginalWidth = null, svgOriginalHeight = null;
    let currentSvgText = '';

    const zoomRange = document.getElementById('zoomRange');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const fitBtn = document.getElementById('fitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefreshCheckbox = document.getElementById('autoRefresh');

    function applyTransform() {
      svgInner.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    }

    function setStatus(s) { statusEl.textContent = s; }

    async function fetchAndShowSvg(cacheBust=false) {
      const url = svgUrlInput.value.trim();
      if (!url) { svgInner.innerHTML = '<div class="text-red-400">No URL</div>'; return; }
      setStatus('Loading…');
      try {
        const fetchUrl = cacheBust ? (url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now()) : url;
        const res = await fetch(fetchUrl);
        if (!res.ok) throw new Error('Network response not ok');
        let text = await res.text();
        text = sanitizeSvgText(text);

        // ensure svg has width/height or viewBox; if missing, wrap into a <svg> — but usually present
        // add class for responsive scaling
        // Insert class attribute safely: replace first <svg... with adding class if not present
        text = text.replace(/<svg([^>]*?)>/i, (m, attrs) => {
          if (/class=/.test(attrs)) return `<svg${attrs}>`;
          return `<svg${attrs} class="w-full h-auto">`;
        });

        // place inline
        svgInner.innerHTML = text;
        currentSvgText = text;

        // try to read natural svg size for fit
        const insertedSvg = svgInner.querySelector('svg');
        if (insertedSvg) {
          const vb = insertedSvg.getAttribute('viewBox');
          if (vb) {
            const parts = vb.split(/\s+/).map(Number);
            if (parts.length === 4) {
              svgOriginalWidth = parts[2]; svgOriginalHeight = parts[3];
            }
          } else {
            // fallback to width/height attrs
            svgOriginalWidth = parseFloat(insertedSvg.getAttribute('width')) || null;
            svgOriginalHeight = parseFloat(insertedSvg.getAttribute('height')) || null;
          }
        }

        // reset transforms and fit initial
        scale = 1; tx = 0; ty = 0; zoomRange.value = scale;
        applyTransform();

        // set download link to raw URL
        downloadLink.onclick = () => {
          // download the current fetched svg as file
          const blob = new Blob([currentSvgText], {type:'image/svg+xml'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (new URL(url)).pathname.split('/').pop() || 'icon.svg';
          document.body.appendChild(a);
          a.click();
          a.remove();
        };

        setStatus('Loaded');
      } catch (err) {
        console.error(err);
        svgInner.innerHTML = '<div class="text-red-400">Error loading SVG.</div>';
        setStatus('Error');
      }
    }

    loadSvgBtn.addEventListener('click', () => fetchAndShowSvg(false));
    refreshBtn.addEventListener('click', () => fetchAndShowSvg(true));

    // zoom controls
    zoomRange.addEventListener('input', (e) => {
      scale = parseFloat(e.target.value);
      applyTransform();
    });
    zoomInBtn.addEventListener('click', () => {
      scale = Math.min(3, +(scale + 0.1).toFixed(2));
      zoomRange.value = scale;
      applyTransform();
    });
    zoomOutBtn.addEventListener('click', () => {
      scale = Math.max(0.2, +(scale - 0.1).toFixed(2));
      zoomRange.value = scale;
      applyTransform();
    });

    // fit to container: attempt to compute bounding box of SVG and scale to fit
    fitBtn.addEventListener('click', () => {
      const svg = svgInner.querySelector('svg');
      if (!svg) return;
      const vb = svg.getAttribute('viewBox');
      let w, h;
      if (vb) {
        const parts = vb.split(/\s+/).map(Number);
        w = parts[2]; h = parts[3];
      } else {
        w = svg.viewBox && svg.viewBox.baseVal && svg.viewBox.baseVal.width || svg.getBoundingClientRect().width;
        h = svg.viewBox && svg.viewBox.baseVal && svg.viewBox.baseVal.height || svg.getBoundingClientRect().height;
      }
      const vw = svgViewport.clientWidth - 20; // padding
      const vh = svgViewport.clientHeight - 20;
      if (!w || !h) return;
      const s = Math.min(vw / w, vh / h);
      scale = Math.max(0.2, Math.min(3, s));
      tx = (vw - w * scale) / 2 - 10;
      ty = (vh - h * scale) / 2 - 10;
      zoomRange.value = scale;
      applyTransform();
    });

    // reset
    resetBtn.addEventListener('click', () => {
      scale = 1; tx = 0; ty = 0; zoomRange.value = scale; applyTransform();
    });

    // pan (drag)
    svgInner.addEventListener('pointerdown', (e) => {
      isDragging = true;
      svgInner.classList.add('dragging');
      dragStart = { x: e.clientX, y: e.clientY, tx, ty };
      svgInner.setPointerCapture(e.pointerId);
    });
    svgInner.addEventListener('pointermove', (e) => {
      if (!isDragging || !dragStart) return;
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      tx = dragStart.tx + dx;
      ty = dragStart.ty + dy;
      applyTransform();
    });
    svgInner.addEventListener('pointerup', (e) => {
      isDragging = false;
      svgInner.classList.remove('dragging');
      try { svgInner.releasePointerCapture(e.pointerId); } catch {}
    });
    svgInner.addEventListener('pointercancel', () => { isDragging=false; svgInner.classList.remove('dragging'); });

    // wheel for zoom (ctrl+wheel or wheel+alt) — scale around cursor
    svgViewport.addEventListener('wheel', (e) => {
      if (!svgInner.querySelector('svg')) return;
      // prefer ctrlKey for zoom, else use wheel with alt/shift
      const doZoom = e.ctrlKey || e.altKey || e.shiftKey;
      if (!doZoom) return;
      e.preventDefault();
      const delta = -e.deltaY;
      const factor = delta > 0 ? 1.08 : 0.92;
      // compute pointer in svgInner coords
      const rect = svgInner.getBoundingClientRect();
      const px = e.clientX - rect.left;
      const py = e.clientY - rect.top;
      // update scale and translate so zoom centers on pointer
      const newScale = Math.min(3, Math.max(0.2, +(scale * factor).toFixed(3)));
      const ratio = newScale / scale;
      // Translate to keep point under cursor fixed
      tx = px - ratio * (px - tx);
      ty = py - ratio * (py - ty);
      scale = newScale;
      zoomRange.value = scale;
      applyTransform();
    }, { passive: false });

    // Auto-refresh
    let autoRefreshHandle = null;
    autoRefreshCheckbox.addEventListener('change', () => {
      if (autoRefreshCheckbox.checked) {
        autoRefreshHandle = setInterval(() => fetchAndShowSvg(true), 30_000);
        setStatus('Auto-refresh ON');
      } else {
        clearInterval(autoRefreshHandle);
        autoRefreshHandle = null;
        setStatus('Auto-refresh OFF');
      }
    });

    // initial load
    fetchAndShowSvg(false);

    // --- Drive gallery loader (keeps the existing behavior) ---
    const driveIdInput = document.getElementById('driveIdInput');
    const setDriveBtn = document.getElementById('setDriveBtn');
    const galleryWrap = document.getElementById('galleryWrap');
    function extractDriveId(value) {
      if (!value) return '';
      const m = value.match(/folders\/([a-zA-Z0-9_-]+)/);
      if (m) return m[1];
      if (/^[a-zA-Z0-9_-]+$/.test(value)) return value;
      return '';
    }
    setDriveBtn.addEventListener('click', () => {
      const raw = driveIdInput.value.trim();
      const id = extractDriveId(raw);
      if (!id) {
        galleryWrap.innerHTML = '<div class="w-full h-[200px] flex items-center justify-center text-red-400">Invalid Drive folder ID or URL.</div>';
        return;
      }
      galleryWrap.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `https://drive.google.com/embeddedfolderview?id=${encodeURIComponent(id)}#grid`;
      iframe.className = 'w-full h-[420px]';
      iframe.frameBorder = '0';
      iframe.allow = 'autoplay';
      galleryWrap.appendChild(iframe);
    });
  </script>
</body>
</html>
